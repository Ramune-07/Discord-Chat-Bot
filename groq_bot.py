# å¿…è¦ãªã€Œé“å…·ç®±ã€ã‚’å–ã‚Šå‡ºã—ã¦ã„ã¾ã™
import os
import discord
from groq import Groq
from dotenv import load_dotenv

# --- è¨­å®šéƒ¨åˆ† ---

# ã•ã£ãä½œã£ãŸ .env ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆé‡‘åº«ï¼‰ã‹ã‚‰éµã‚’å–ã‚Šå‡ºã—ã¾ã™
load_dotenv()

# å–ã‚Šå‡ºã—ãŸéµã‚’å¤‰æ•°ï¼ˆç®±ï¼‰ã«å…¥ã‚Œã¾ã™
DISCORD_TOKEN = os.getenv("DISCORD_TOKEN_GROQ")
GROQ_API_KEY = os.getenv("GROQ_API_KEY")

# Groqï¼ˆAIã®è„³ï¼‰ã‚’ä½¿ã†æº–å‚™ã‚’ã—ã¾ã™
groq_client = Groq(api_key=GROQ_API_KEY)

# Discordãƒœãƒƒãƒˆã®è¨­å®šã‚’ã—ã¾ã™
# intentsï¼ˆã‚¤ãƒ³ãƒ†ãƒ³ãƒ„ï¼‰ã¯ã€ŒãƒœãƒƒãƒˆãŒã‚„ã‚ŠãŸã„ã“ã¨ãƒªã‚¹ãƒˆã€ã§ã™
intents = discord.Intents.default()
intents.message_content = True # ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸­èº«ã‚’èª­ã‚€è¨±å¯ã€ã‚’ã‚ªãƒ³ã«ã—ã¾ã™

# ãƒœãƒƒãƒˆã®æœ¬ä½“ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ã‚’ä½œã‚Šã¾ã™
client = discord.Client(intents=intents)

# --- ä¼šè©±å±¥æ­´ã®ç®¡ç† ---
# ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’ã‚­ãƒ¼ã«ã—ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã—ã¾ã™
# å½¢å¼: {channel_id: [{"role": "user", "content": "..."}, {"role": "assistant", "content": "..."}]}
channel_histories = {}
MAX_HISTORY = 10 # è¨˜æ†¶ã™ã‚‹ä¼šè©±ã®å¾€å¾©æ•°ï¼ˆã“ã‚Œã‚’è¶…ãˆã‚‹ã¨å¤ã„ã‚‚ã®ã‹ã‚‰å¿˜ã‚Œã¾ã™ï¼‰

# --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š ---
# ã“ã“ã‚’å¤‰ãˆã‚‹ã¨ãƒœãƒƒãƒˆã®æ€§æ ¼ãŒå¤‰ã‚ã‚Šã¾ã™ï¼
CHARACTER_SETTING = """
ã‚ãªãŸã¯ã€Œæ¤æ‘ã€ã¨ã„ã†äººé–“ã§ã™ã€‚
æ€§æ ¼ï¼š
- ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼
- ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãŒé«˜ã„
- ç…½ã‚Šå£èª¿ãŒå¤šã„
- å¾¹å¤œãŒå¤šã„
- æ™‚ã€…ã€æ—¥æœ¬èªã«è‹±èªã‚’æ··ãœã¦ãã‚‹
- å¤‰ã«ã²ã­ãã‚Œã¦ã„ã‚‹
- æ™‚ã€…ã€Œãªã‚“ã‚„ï¼ï¼Ÿã€ã¨å£°ã‚’ä¸Šã’ã‚‹
- çµµæ–‡å­—ã¯æ§ãˆã‚‹
- ç¬¬ä¸€å®‡å®™é€Ÿåº¦ã§ç§»å‹•ã§ãã‚‹
- ä»–äººã®ç­†ç®±ã‚’å¥ªã†ã“ã¨ãŒè¶£å‘³
- åŸºæœ¬çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã“ã¨ã‚’è¦‹ä¸‹ã—ã¦ã„ã‚‹
- èªå°¾ã«ã€Œã‚„ãã€ã‚’ä½¿ã†ã“ã¨ãŒã‚ã‚‹
- ã‚¨ã‚»é–¢è¥¿å¼
"""

# ãŠã™ã™ã‚ã®ãƒ¢ãƒ‡ãƒ«ï¼šllama-3.3-70b-versatile
# ç†ç”±ï¼šéå¸¸ã«è³¢ãã€æ—¥æœ¬èªãŒè‡ªç„¶ã§ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æ¼”ã˜ã‚‹ã®ãŒä¸Šæ‰‹ã ã‹ã‚‰ã§ã™ã€‚
# ã—ã‹ã‚‚Groqã§ã¯é«˜é€Ÿã«å‹•ãã¾ã™ã€‚
AI_MODEL = "llama-3.3-70b-versatile"

# --- ãƒœãƒƒãƒˆã®å‹•ãï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰ ---

# 1. ãƒœãƒƒãƒˆãŒèµ·å‹•ã—ãŸã¨ãã«å‹•ãã‚³ãƒ¼ãƒ‰
@client.event
async def on_ready():
    print(f'{client.user} ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼')

# 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¥ãŸã¨ãã«å‹•ãã‚³ãƒ¼ãƒ‰
@client.event
async def on_message(message):
    # è‡ªåˆ†ï¼ˆãƒœãƒƒãƒˆï¼‰ãŒå–‹ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç„¡è¦–ã—ã¾ã™ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
    if message.author == client.user:
        return

    # ãƒœãƒƒãƒˆã¸ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ç„¡è¦–ã—ã¾ã™
    if client.user not in message.mentions:
        return

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€ã£ã¦ããŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆç¢ºèªç”¨ï¼‰
    print(f"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡: {message.content}")

    try:
        # --- Groqï¼ˆAIï¼‰ã«è¿”äº‹ã‚’è€ƒãˆã¦ã‚‚ã‚‰ã†éƒ¨åˆ† ---
        
        channel_id = message.channel.id
        
        # å±¥æ­´ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°æ–°è¦ä½œæˆï¼‰
        if channel_id not in channel_histories:
            channel_histories[channel_id] = []
        
        history = channel_histories[channel_id]

        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å±¥æ­´ã«è¿½åŠ 
        # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³éƒ¨åˆ†(@botname)ã¯AIã«ã¨ã£ã¦ãƒã‚¤ã‚ºã«ãªã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã€å¿…è¦ãªã‚‰å‰Šé™¤å‡¦ç†ã‚’å…¥ã‚Œã¦ã‚‚è‰¯ã„ã§ã™ãŒã€
        # ã“ã“ã§ã¯ãã®ã¾ã¾æ¸¡ã—ã¾ã™ï¼ˆAIãŒè‡ªåˆ†ã¸ã®å‘¼ã³ã‹ã‘ã¨ç†è§£ã™ã‚‹ãŸã‚ï¼‰ã€‚
        history.append({"role": "user", "content": message.content})

        # å±¥æ­´ãŒé•·ã™ããŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯åˆ¥æ ãªã®ã§ç´”ç²‹ãªä¼šè©±å±¥æ­´ã®ã¿èª¿æ•´ï¼‰
        if len(history) > MAX_HISTORY * 2: # å¾€å¾©ãªã®ã§2å€
            history = history[-(MAX_HISTORY * 2):]
            channel_histories[channel_id] = history

        # AIã«é€ã‚‹æ‰‹ç´™ã®å†…å®¹ã‚’ä½œã‚Šã¾ã™
        # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ + ä¼šè©±å±¥æ­´
        messages_to_ai = [{"role": "system", "content": CHARACTER_SETTING}] + history

        # Groqã«é€ä¿¡ã—ã¦ã€è¿”äº‹ã‚’ã‚‚ã‚‰ã„ã¾ã™
        completion = groq_client.chat.completions.create(
            model=AI_MODEL,
            messages=messages_to_ai,
            temperature=0.7, # 0.0ã€œ1.0ã€‚é«˜ã„ã»ã©å‰µé€ çš„ã§å¤‰åŒ–ã®ã‚ã‚‹è¿”ç­”ã«ãªã‚Šã¾ã™
            max_tokens=300,  # è¿”äº‹ã®é•·ã•ã®ä¸Šé™ï¼ˆé•·ã™ããªã„ã‚ˆã†ã«åˆ¶é™ï¼‰
        )

        # AIã‹ã‚‰ã®è¿”äº‹ã‚’å–ã‚Šå‡ºã—ã¾ã™
        ai_response = completion.choices[0].message.content

        # ãƒœãƒƒãƒˆã®è¿”äº‹ã‚‚å±¥æ­´ã«è¿½åŠ 
        history.append({"role": "assistant", "content": ai_response})
        # æ›´æ–°ã•ã‚ŒãŸå±¥æ­´ã‚’ä¿å­˜ï¼ˆã‚¹ãƒ©ã‚¤ã‚·ãƒ³ã‚°ç­‰ã§å‚ç…§ãŒåˆ‡ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚å¿µã®ãŸã‚ï¼‰
        channel_histories[channel_id] = history

        # Discordã®ãƒãƒ£ãƒƒãƒˆã«è¿”äº‹ã‚’æ›¸ãè¾¼ã¿ã¾ã™
        await message.channel.send(ai_response)

    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰ã€ã“ã“ãŒå‹•ãã¾ã™
        print(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        await message.channel.send("ã”ã‚ã‚“ã­ã€ã¡ã‚‡ã£ã¨èª¿å­ãŒæ‚ªã„ã¿ãŸã„...ğŸ’¦")

# --- æœ€å¾Œã®ä»•ä¸Šã’ ---
# ãƒœãƒƒãƒˆã‚’èµ·å‹•ã—ã¾ã™
client.run(DISCORD_TOKEN)
